{% extends 'base.html' %}

{% block content %}
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap" rel="stylesheet">
<style>
.errorlog-container {
    padding: 100px 40px 80px;
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}
.errorlog-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(7, 1fr);
    gap: 20px;
    max-width: 900px;
    width: 100%;
}
.errorlog-item {
    background-color: #BFBFBF;
    padding: 15px;
    text-align: center;
    font-size: 1.5rem;
    border-radius: 2px;
    font-family: 'Montserrat', Arial, Helvetica, sans-serif;
    font-weight: 400;
    transition: opacity 0.2s, box-shadow 0.2s;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 60px;
}
.errorlog-item.header {
    font-size: 2rem;
    font-weight: bold;
    background-color: #BFBFBF;
    cursor: default;
    box-shadow: none;
}
.errorlog-item:hover:not(.header) {
    opacity: 0.9;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
.error-history {
    margin-top: 20px;
    width: 100%;
    max-width: 900px;
    background-color: #BFBFBF;
    padding: 20px;
    border-radius: 2px;
    position: relative;
}
.error-history h2 {
    font-family: 'Montserrat', Arial, Helvetica, sans-serif;
    margin-bottom: 20px;
    text-align: center;
}
.clear-history-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 8px 16px;
    background-color: #f44336;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Montserrat', Arial, Helvetica, sans-serif;
    transition: background-color 0.3s;
}
.clear-history-btn:hover {
    background-color: #d32f2f;
}
.error-count {
    background-color: #666;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    margin-left: 8px;
}
.error-table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Montserrat', Arial, Helvetica, sans-serif;
}
.error-table th, .error-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #999;
}
.error-table th {
    background-color: #999;
    color: white;
}
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}
.status-connected {
    background-color: #4CAF50;
}
.status-disconnected {
    background-color: #f44336;
}
.status-warning {
    background-color: #ff9800;
}
@media (max-width: 950px) {
    .errorlog-grid {
        max-width: 99vw;
        font-size: 1.1rem;
    }
    .errorlog-item, .errorlog-item.header {
        font-size: 1.1rem;
        padding: 10px;
    }
    .error-table {
        font-size: 0.9rem;
    }
}
.gps-card {
    background-color: #BFBFBF;
    padding: 20px;
    border-radius: 8px;
    width: 100%;
    max-width: 600px;
    font-family: 'Montserrat', Arial, Helvetica, sans-serif;
    margin: 0 auto;
}
.gps-header {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
}
.gps-data {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}
.data-item {
    background-color: #fff;
    padding: 15px;
    border-radius: 4px;
    text-align: center;
}
.data-label {
    font-size: 14px;
    color: #666;
    margin-bottom: 5px;
}
.data-value {
    font-size: 18px;
    font-weight: bold;
}
.raw-data {
    margin-top: 20px;
    background-color: #fff;
    padding: 15px;
    border-radius: 4px;
    font-family: monospace;
    white-space: pre-wrap;
    max-height: 200px;
    overflow-y: auto;
}
</style>
<div class="errorlog-container">
    <div class="errorlog-grid">
        <div class="errorlog-item header">Components</div>
        <div class="errorlog-item header">Status</div>
        <div class="errorlog-item header">Live Data</div>

        <div class="errorlog-item">Water Level</div>
        <div class="errorlog-item" id="waterStatus">...</div>
        <div class="errorlog-item" id="waterValue">...</div>

        <div class="errorlog-item">pH Level</div>
        <div class="errorlog-item" id="phStatus">...</div>
        <div class="errorlog-item" id="phValue">...</div>

        <div class="errorlog-item">Turbidity</div>
        <div class="errorlog-item" id="turbStatus">...</div>
        <div class="errorlog-item" id="turbValue">...</div>

        <div class="errorlog-item">Dissolved Oxygen</div>
        <div class="errorlog-item" id="doStatus">...</div>
        <div class="errorlog-item" id="doValue">...</div>

        <div class="errorlog-item">Temperature</div>
        <div class="errorlog-item" id="tempStatus">...</div>
        <div class="errorlog-item" id="tempValue">...</div>
    </div>

    <!-- GPS Card below the grid -->
    <div style="width: 100%; display: flex; justify-content: center; margin: 20px 0;">
        <div class="gps-card">
            <div class="gps-header">GPS Test Data</div>
            <div class="gps-data">
                <div class="data-item">
                    <div class="data-label">Latitude</div>
                    <div class="data-value" id="gps-latitude">--.------</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Longitude</div>
                    <div class="data-value" id="gps-longitude">--.------</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Date</div>
                    <div class="data-value" id="gps-date">--/--/----</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Time</div>
                    <div class="data-value" id="gps-time">--:--:--</div>
                </div>
            </div>
            <div class="data-item" style="grid-column: 1 / -1;">
                <div class="data-label">Status</div>
                <div class="data-value" id="gps-status">
                    <span class="status-indicator status-disconnected"></span>
                    Disconnected
                </div>
            </div>
            <div class="raw-data" id="gps-rawData">
                Waiting for GPS data...
            </div>
        </div>
    </div>

    <div class="error-history">
        <h2>Recent Error History</h2>
        <button class="clear-history-btn" onclick="clearErrorHistory()">Clear History</button>
        <table class="error-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Component</th>
                    <th>Error Type</th>
                    <th>Message</th>
                    <th>Severity</th>
                </tr>
            </thead>
            <tbody id="errorHistory">
                <!-- Error history will be populated here -->
            </tbody>
        </table>
    </div>
</div>
<script>
function updateErrorLogGrid() {
    fetch('/api/live_sample')
        .then(res => res.json())
        .then(data => {
            // Water Level
            if (data.water_level && data.water_level.status === 'connected') {
                document.getElementById('waterStatus').innerHTML = '<span class="status-indicator status-connected"></span>Connected';
                document.getElementById('waterValue').textContent = data.water_level.detected;
            } else {
                document.getElementById('waterStatus').innerHTML = '<span class="status-indicator status-disconnected"></span>Disconnected';
                document.getElementById('waterValue').textContent = '----/----';
            }
            
            // pH
            if (data.ph && typeof data.ph.ph === 'number') {
                document.getElementById('phStatus').innerHTML = '<span class="status-indicator status-connected"></span>Connected';
                document.getElementById('phValue').textContent = data.ph.ph.toFixed(2);
            } else {
                document.getElementById('phStatus').innerHTML = '<span class="status-indicator status-disconnected"></span>Disconnected';
                document.getElementById('phValue').textContent = '----/----';
            }
            // Turbidity
            var turbVal = data.turbidity && data.turbidity.voltage;
            if (turbVal != null && !isNaN(Number(turbVal))) {
                document.getElementById('turbStatus').innerHTML = '<span class="status-indicator status-connected"></span>Connected';
                document.getElementById('turbValue').textContent = Number(turbVal).toFixed(2);
            } else {
                document.getElementById('turbStatus').innerHTML = '<span class="status-indicator status-disconnected"></span>Disconnected';
                document.getElementById('turbValue').textContent = '----/----';
            }
            // DO
            if (data.do && typeof data.do.do === 'number') {
                document.getElementById('doStatus').innerHTML = '<span class="status-indicator status-connected"></span>Connected';
                document.getElementById('doValue').textContent = data.do.do.toFixed(2);
            } else {
                document.getElementById('doStatus').innerHTML = '<span class="status-indicator status-disconnected"></span>Disconnected';
                document.getElementById('doValue').textContent = '----/----';
            }
            // Temp
            if (typeof data.temp === 'number') {
                document.getElementById('tempStatus').innerHTML = '<span class="status-indicator status-connected"></span>Connected';
                document.getElementById('tempValue').textContent = data.temp.toFixed(2);
            } else {
                document.getElementById('tempStatus').innerHTML = '<span class="status-indicator status-disconnected"></span>Disconnected';
                document.getElementById('tempValue').textContent = '----/----';
            }
            // GPS
            fetch('/api/gps')
                .then(res => res.json())
                .then(gps => {
                    if (gps && gps.lat && gps.lng) {
                        document.getElementById('gps-status').innerHTML = '<span class="status-indicator status-connected"></span>Connected';
                        document.getElementById('gps-latitude').textContent = gps.lat.toFixed(6);
                        document.getElementById('gps-longitude').textContent = gps.lng.toFixed(6);
                        if (gps.date) document.getElementById('gps-date').textContent = gps.date;
                        if (gps.time) document.getElementById('gps-time').textContent = gps.time;
                    } else {
                        document.getElementById('gps-status').innerHTML = '<span class="status-indicator status-disconnected"></span>Disconnected';
                        document.getElementById('gps-latitude').textContent = '--.------';
                        document.getElementById('gps-longitude').textContent = '--.------';
                        document.getElementById('gps-date').textContent = '--/--/----';
                        document.getElementById('gps-time').textContent = '--:--:--';
                    }
                })
                .catch(() => {
                    document.getElementById('gps-status').innerHTML = '<span class="status-indicator status-disconnected"></span>Disconnected';
                    document.getElementById('gps-latitude').textContent = '--.------';
                    document.getElementById('gps-longitude').textContent = '--.------';
                    document.getElementById('gps-date').textContent = '--/--/----';
                    document.getElementById('gps-time').textContent = '--:--:--';
                });
        });
}

function clearErrorHistory() {
    if (confirm('Are you sure you want to clear the error history?')) {
        fetch('/api/error-logs/clear', { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    updateErrorHistory();
                }
            })
            .catch(error => console.error('Error clearing history:', error));
    }
}

function updateErrorHistory() {
    fetch('/api/error-logs')
        .then(res => res.json())
        .then(logs => {
            const tbody = document.getElementById('errorHistory');
            tbody.innerHTML = '';
            
            // Group similar errors
            const errorGroups = {};
            logs.forEach(log => {
                const key = `${log.component}-${log.error_type}-${log.message}`;
                if (!errorGroups[key]) {
                    errorGroups[key] = {
                        ...log,
                        count: 1,
                        firstOccurrence: new Date(log.timestamp)
                    };
                } else {
                    errorGroups[key].count++;
                    // Keep the most recent timestamp
                    errorGroups[key].timestamp = log.timestamp;
                }
            });

            // Sort by timestamp (most recent first)
            const sortedGroups = Object.values(errorGroups).sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );

            sortedGroups.forEach(log => {
                const row = document.createElement('tr');
                const time = new Date(log.timestamp).toLocaleString();
                const severityClass = log.severity.toLowerCase() === 'error' ? 'status-disconnected' : 
                                    log.severity.toLowerCase() === 'warning' ? 'status-warning' : 'status-connected';
                
                row.innerHTML = `
                    <td>${time}</td>
                    <td>${log.component}</td>
                    <td>${log.error_type}</td>
                    <td>${log.message} ${log.count > 1 ? `<span class="error-count">${log.count}</span>` : ''}</td>
                    <td><span class="status-indicator ${severityClass}"></span>${log.severity}</td>
                `;
                tbody.appendChild(row);
            });
        });
}

// Update both grid and history every second
setInterval(() => {
    updateErrorLogGrid();
    updateErrorHistory();
}, 1000);

// Initial update
updateErrorLogGrid();
updateErrorHistory();

function updateGPSCard() {
    fetch('/api/gps')
        .then(res => res.json())
        .then(data => {
            if (data.lat && data.lng) {
                document.getElementById('gps-latitude').textContent = data.lat.toFixed(6);
                document.getElementById('gps-longitude').textContent = data.lng.toFixed(6);
                document.getElementById('gps-status').innerHTML = 
                    '<span class="status-indicator status-connected"></span>Connected';
                if (data.date) {
                    document.getElementById('gps-date').textContent = data.date;
                }
                if (data.time) {
                    document.getElementById('gps-time').textContent = data.time;
                }
                document.getElementById('gps-rawData').textContent = 
                    `Raw NMEA: ${data.raw || 'No raw data'}\n` +
                    `Last Update: ${new Date().toLocaleString()}`;
            } else {
                document.getElementById('gps-status').innerHTML = 
                    '<span class="status-indicator status-disconnected"></span>Disconnected';
                document.getElementById('gps-rawData').textContent = 'No GPS data available';
                document.getElementById('gps-latitude').textContent = '--.------';
                document.getElementById('gps-longitude').textContent = '--.------';
                document.getElementById('gps-date').textContent = '--/--/----';
                document.getElementById('gps-time').textContent = '--:--:--';
            }
        })
        .catch(error => {
            document.getElementById('gps-status').innerHTML = 
                '<span class="status-indicator status-disconnected"></span>Error';
            document.getElementById('gps-rawData').textContent = 'Error fetching GPS data';
        });
}
setInterval(updateGPSCard, 1000);
updateGPSCard();

// Function to update turbidity data
function updateTurbidity() {
    fetch('/read-turbidity')
        .then(response => response.text())
        .then(data => {
            document.getElementById('turbValue').textContent = data;
        })
        .catch(error => {
            console.error('Error fetching turbidity data:', error);
            document.getElementById('turbValue').textContent = 'Error';
        });
}

// Update turbidity data every 2 seconds
setInterval(updateTurbidity, 2000);
// Initial update
updateTurbidity();
</script>
{% endblock %} 