from adafruit_pca9685 import PCA9685
from adafruit_tca9548a import TCA9548A
from board import SCL, SDA
import busio
import time
import threading

# Setup I2C and TCA9548A multiplexer
i2c = busio.I2C(SCL, SDA)
tca = TCA9548A(i2c)
pca_i2c = tca[0]  # PCA9685 on channel 0
pca = PCA9685(pca_i2c)
pca.frequency = 50  # Standard for servos

# Convert angle to PWM signal
def angle_to_pwm(angle):
    pulse = 500 + (angle / 180) * 2000  # in microseconds
    duty_cycle = int((pulse / 20000) * 65535)
    return duty_cycle

# Move servo slowly
def smooth_move(channel, current, target, delay):
    step = 1 if target > current else -1
    for angle in range(current, target + step, step):
        pca.channels[channel].duty_cycle = angle_to_pwm(angle)
        time.sleep(delay)
    return target

# Threaded move
def threaded_servo_move(channel, target_angle, delay):
    global current_angles
    current = current_angles[channel]
    current_angles[channel] = smooth_move(channel, current, target_angle, delay)

def move_both_channels(targets):
    threads = []
    for ch in targets:
        thread = threading.Thread(target=threaded_servo_move, args=(ch, targets[ch], servo_config[ch]["delay"]))
        threads.append(thread)
        thread.start()
    for thread in threads:
        thread.join()

# Servo configuration
servo_config = {
    9: {"min": 90, "max": 180, "init": 180, "delay": 0.04},  # Slower now
    10: {"min": 0, "max": 100, "init": 90, "delay": 0.08}    # Already slow
}

# Current positions
current_angles = {
    9: servo_config[9]["init"],
    10: servo_config[10]["init"]
}

# Object positions
object_positions = {
    "A": {9: 120, 10: 30},  # Plant Pots
    "B": {9: 100, 10: 75},  # Bamboo Stump
    "C": {9: 120, 10: 30},  # Tires
    "D": {9: 100, 10: 75}   # Bamboo Planter
}

# Straight position
straight_position = {
    9: 90,
    10: 0
}

# Initialize to resting positions
def initialize_servos():
    print("Initializing servos...")
    move_both_channels({9: servo_config[9]["init"], 10: servo_config[10]["init"]})
    print("Initialization complete.\n")

# Prepare hand for object detection
def prepare_hand_for_object(obj_label):
    """
    Prepare the robotic hand for the detected object.
    obj_label should be one of: "A", "B", "C", "D"
    """
    if obj_label not in object_positions:
        print(f"Unknown object: {obj_label}")
        return False

    try:
        # Move to straightened position first
        print("Straightening arm...")
        move_both_channels(straight_position)
        time.sleep(1)  # Wait for arm to stabilize

        # Move to object position
        print(f"Moving to {obj_label} position...")
        move_both_channels(object_positions[obj_label])
        print(f"Arm positioned for object {obj_label}.")
        return True
    except Exception as e:
        print(f"Error positioning arm: {e}")
        return False

# Return to rest position
def return_to_rest():
    try:
        print("Returning to rest position...")
        move_both_channels({9: servo_config[9]["init"], 10: servo_config[10]["init"]})
        print("Arm back to rest.")
        return True
    except Exception as e:
        print(f"Error returning to rest: {e}")
        return False

# Initialize servos on module import
initialize_servos() 
